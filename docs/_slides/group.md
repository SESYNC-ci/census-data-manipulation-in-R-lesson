---
# group by NAICS, sum across county
---

## Split-apply-combine

A very common data manipulation procedure is doing some "group-wise" operations
on a dataset and combing the results for each group into a single table. For
example, say you need to sum the number of employees *in each state* observed in
the health care sector?

===

## Grouping

The dplyr function `group_by` begins the process by indicating how the data frame should be split into subsets.



~~~r
state_cbp_health_care <- cbp_health_care %>%
    group_by(FIPSTATE)
~~~
{:.text-document title="{{ site.handouts[0] }}"}


===

At this point, nothing has really changed:



~~~r
> str(state_cbp_health_care)
~~~
{:.input title="Console"}


~~~
Classes 'grouped_df', 'tbl_df', 'tbl' and 'data.frame':	63231 obs. of  7 variables:
 $ FIPSTATE: chr  "01" "01" "01" "01" ...
 $ FIPSCTY : chr  "001" "001" "001" "001" ...
 $ NAICS   : chr  "621111" "621210" "621310" "621320" ...
 $ EMPFLAG : chr  NA NA NA NA ...
 $ EMP_NF  : chr  "G" "H" "G" "J" ...
 $ EMP     : int  156 95 27 36 31 0 0 0 0 0 ...
 $ FIPS    : chr  "01001" "01001" "01001" "01001" ...
 - attr(*, "vars")= chr "FIPSTATE"
 - attr(*, "drop")= logi TRUE
 - attr(*, "indices")=List of 51
  ..$ : int  0 1 2 3 4 5 6 7 8 9 ...
  ..$ : int  1394 1395 1396 1397 1398 1399 1400 1401 1402 1403 ...
  ..$ : int  1741 1742 1743 1744 1745 1746 1747 1748 1749 1750 ...
  ..$ : int  2181 2182 2183 2184 2185 2186 2187 2188 2189 2190 ...
  ..$ : int  3581 3582 3583 3584 3585 3586 3587 3588 3589 3590 ...
  ..$ : int  5322 5323 5324 5325 5326 5327 5328 5329 5330 5331 ...
  ..$ : int  6465 6466 6467 6468 6469 6470 6471 6472 6473 6474 ...
  ..$ : int  6749 6750 6751 6752 6753 6754 6755 6756 6757 6758 ...
  ..$ : int  6860 6861 6862 6863 6864 6865 6866 6867 6868 6869 ...
  ..$ : int  6899 6900 6901 6902 6903 6904 6905 6906 6907 6908 ...
  ..$ : int  8760 8761 8762 8763 8764 8765 8766 8767 8768 8769 ...
  ..$ : int  11516 11517 11518 11519 11520 11521 11522 11523 11524 11525 ...
  ..$ : int  11653 11654 11655 11656 11657 11658 11659 11660 11661 11662 ...
  ..$ : int  12396 12397 12398 12399 12400 12401 12402 12403 12404 12405 ...
  ..$ : int  14431 14432 14433 14434 14435 14436 14437 14438 14439 14440 ...
  ..$ : int  16536 16537 16538 16539 16540 16541 16542 16543 16544 16545 ...
  ..$ : int  18331 18332 18333 18334 18335 18336 18337 18338 18339 18340 ...
  ..$ : int  19824 19825 19826 19827 19828 19829 19830 19831 19832 19833 ...
  ..$ : int  21935 21936 21937 21938 21939 21940 21941 21942 21943 21944 ...
  ..$ : int  23265 23266 23267 23268 23269 23270 23271 23272 23273 23274 ...
  ..$ : int  23720 23721 23722 23723 23724 23725 23726 23727 23728 23729 ...
  ..$ : int  24460 24461 24462 24463 24464 24465 24466 24467 24468 24469 ...
  ..$ : int  24943 24944 24945 24946 24947 24948 24949 24950 24951 24952 ...
  ..$ : int  26883 26884 26885 26886 26887 26888 26889 26890 26891 26892 ...
  ..$ : int  28674 28675 28676 28677 28678 28679 28680 28681 28682 28683 ...
  ..$ : int  30011 30012 30013 30014 30015 30016 30017 30018 30019 30020 ...
  ..$ : int  32214 32215 32216 32217 32218 32219 32220 32221 32222 32223 ...
  ..$ : int  32974 32975 32976 32977 32978 32979 32980 32981 32982 32983 ...
  ..$ : int  34037 34038 34039 34040 34041 34042 34043 34044 34045 34046 ...
  ..$ : int  34314 34315 34316 34317 34318 34319 34320 34321 34322 34323 ...
  ..$ : int  34623 34624 34625 34626 34627 34628 34629 34630 34631 34632 ...
  ..$ : int  35375 35376 35377 35378 35379 35380 35381 35382 35383 35384 ...
  ..$ : int  36045 36046 36047 36048 36049 36050 36051 36052 36053 36054 ...
  ..$ : int  37909 37910 37911 37912 37913 37914 37915 37916 37917 37918 ...
  ..$ : int  40404 40405 40406 40407 40408 40409 40410 40411 40412 40413 ...
  ..$ : int  40982 40983 40984 40985 40986 40987 40988 40989 40990 40991 ...
  ..$ : int  43357 43358 43359 43360 43361 43362 43363 43364 43365 43366 ...
  ..$ : int  44780 44781 44782 44783 44784 44785 44786 44787 44788 44789 ...
  ..$ : int  45668 45669 45670 45671 45672 45673 45674 45675 45676 45677 ...
  ..$ : int  47683 47684 47685 47686 47687 47688 47689 47690 47691 47692 ...
  ..$ : int  47848 47849 47850 47851 47852 47853 47854 47855 47856 47857 ...
  ..$ : int  48936 48937 48938 48939 48940 48941 48942 48943 48944 48945 ...
  ..$ : int  49662 49663 49664 49665 49666 49667 49668 49669 49670 49671 ...
  ..$ : int  51573 51574 51575 51576 51577 51578 51579 51580 51581 51582 ...
  ..$ : int  55568 55569 55570 55571 55572 55573 55574 55575 55576 55577 ...
  ..$ : int  56101 56102 56103 56104 56105 56106 56107 56108 56109 56110 ...
  ..$ : int  56449 56450 56451 56452 56453 56454 56455 56456 56457 56458 ...
  ..$ : int  59014 59015 59016 59017 59018 59019 59020 59021 59022 59023 ...
  ..$ : int  60005 60006 60007 60008 60009 60010 60011 60012 60013 60014 ...
  ..$ : int  61077 61078 61079 61080 61081 61082 61083 61084 61085 61086 ...
  ..$ : int  62760 62761 62762 62763 62764 62765 62766 62767 62768 62769 ...
 - attr(*, "group_sizes")= int  1394 347 440 1400 1741 1143 284 111 39 1861 ...
 - attr(*, "biggest_group_size")= int 3995
 - attr(*, "labels")='data.frame':	51 obs. of  1 variable:
  ..$ FIPSTATE: chr  "01" "02" "04" "05" ...
  ..- attr(*, "vars")= chr "FIPSTATE"
  ..- attr(*, "drop")= logi TRUE
~~~
{:.output}


The `group_by` statement does not change any values in the data frame; it only
adds attributes to the the original data frame. You can add multiple variables
(separated by commas) in `group_by`; each distinct combination of values across
these columns defines a different group.
{:.notes}

===

## Summarize

The operation to perform on each species is summing: we need to sum employment
are in each group.



~~~r
state_cbp_health_care <- cbp_health_care %>%
    group_by(FIPSTATE) %>%
    summarize(EMP = sum(EMP))
~~~
{:.text-document title="{{ site.handouts[0] }}"}


===



~~~r
> str(state_cbp_health_care)
~~~
{:.input title="Console"}


~~~
Classes 'tbl_df', 'tbl' and 'data.frame':	51 obs. of  2 variables:
 $ FIPSTATE: chr  "01" "02" "04" "05" ...
 $ EMP     : int  162202 35063 325251 114101 1789324 240330 262599 60290 65472 950356 ...
~~~
{:.output}


===

The "combine" part of "split-apply-combine" occurs automatically, when the attributes introduced by `group_by` are dropped. You can see attributes either by running the `str()` function on the data frame or by inspecting it in the RStudio *Environment* pane.

===

The function `n()` takes no arguments and returns the number of records in a group. Any function that collapses a vector input to a single output is a suitable function to use within `summarize`.



~~~r
state_cbp_health_care <- cbp_health_care %>%
    group_by(FIPSTATE) %>%
    summarize(EMP = sum(EMP),
              counties = n())
~~~
{:.text-document title="{{ site.handouts[0] }}"}


===

But `group_by` can't read your mind, so be careful to type what you mean! 



~~~r
> head(state_cbp_health_care)
~~~
{:.input title="Console"}


~~~
# A tibble: 6 x 3
  FIPSTATE     EMP counties
  <chr>      <int>    <int>
1 01        162202     1394
2 02         35063      347
3 04        325251      440
4 05        114101     1400
5 06       1789324     1741
6 08        240330     1143
~~~
{:.output}

